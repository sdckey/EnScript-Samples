/*
   This code-sample demonstrates submission of a hash to the MalwareBazaar web service.

   The API used is that documented at the following URL:

   - https://bazaar.abuse.ch/api/#query_hash

   Please note that this script is not an endorsement of the MalwareBazaar service

   Developed using EnCase 21.04.00.109.

   Report bugs to -

   Simon Key <skey@opentext.com>

   26th August 2022
 */

class MainClass {
  void Main(CaseClass c) {
    SystemClass::ClearConsole(1);

    String host = "mb-api.abuse.ch",
           url  = "/api/v1/";

    NameValueClass headers();

    // HTTP POST form values

    new NameValueClass(headers, "query", 0, "get_info");
    new NameValueClass(headers, "hash", 0, "7de2c1bf58bce09eecc70476747d88a26163c3d6bb1d85235c24a558d1f16754");

    WebClientClass client();

    // Open the web connection

    if (client.Open(host, SocketClass::HTTPSPORT, SSL))
    {
      Console.WriteLine("Connection opened.");

      WebServiceClass::RequestClass request();
      request.URL = url;
      request.Command = WebServiceClass::RequestClass::POST;

      // Add the form values to the request's post-list

      foreach (NameValueClass header in headers)
      {
        request.PostList.Insert(header);
      }

      // Set the content-type request header so that the service knows we're sending form-data

      new NameValueClass(request.Variables, "content-type", 0, "application/x-www-form-urlencoded");

      WebServiceClass::ReplyClass reply();

      // Execute the command

      if (client.Command(request, reply))
      {
        Console.WriteLine("Command executed.");
        FileClass f = reply.File;
        if (f && f.IsOpen())
        {
          f.Reset(TEXT);
          String response_text;
          f.ReadString(response_text);
          Console.WriteLine(response_text);
        }
      }
    }
  }
}
